<?xml version="1.0" encoding="UTF-8"?>
<!--
@authur:liuqing
@time:2011-11-3
-->
<sqls>

    <!--点门牌-->
    <feature name="IX_POINTADDRESS">
        <step value="7">
            <!--按图幅过滤IX_POI-->
            <sql>
                <![CDATA[
                        INSERT /*+ append */
                        INTO TEMP_FILTER_IX_POINTADDRESS
                          (PID)
                          (SELECT DISTINCT AUDATA_ID FROM TMAU_EXP_AU_IX_POINTADDRESS WHERE BATCH_ID [batch]);
                        ]]></sql>
            <!-- 按任务过滤TMAU表中外业任务号 -->
            <sql>
                <![CDATA[
                        INSERT /*+ append */
                        INTO TEMP_AU_PA_FIELD_TASK
                          (PID)
                          (SELECT DISTINCT ID FROM TMAU_EXP_AU_FIELDTASK WHERE BATCH_ID [batch]);
                        ]]></sql>
        </step>
        <step value="10">

            <!--	父在图幅内，子在图幅外，子提取-->
            <sql>
                <![CDATA[
                        INSERT /*+ append */
                        INTO TEMP_IX_POINTADDRESS
                          (PID)
                        (SELECT AUDATA_ID FROM
                          (WITH CH AS
                            (SELECT /*+ ORDERED USE_HASH(P) USE_HASH(C) NO_SWAP_JOIN_INPUTS(C)*/
							 C.AUDATA_ID,C.FIELD_TASK_ID
							  FROM TEMP_FILTER_IX_POINTADDRESS T,
							       AU_IX_POINTADDRESS_PARENT     P,
							       AU_IX_POINTADDRESS_CHILDREN   C
							 WHERE P.GROUP_ID = C.GROUP_ID
							   AND P.AUDATA_ID = T.PID)
                           SELECT CH.AUDATA_ID FROM CH,TEMP_AU_PA_FIELD_TASK TP WHERE CH.FIELD_TASK_ID=TP.PID
                           UNION ALL SELECT CH.AUDATA_ID FROM CH WHERE NOT EXISTS(SELECT 1 FROM TEMP_AU_PA_FIELD_TASK)));
                        ]]></sql>

            <!--	子在图幅内，父在图幅外，父提取，父的其他子不提-->
            <sql>
                <![CDATA[
                        INSERT /*+ append */
                        INTO TEMP_IX_POINTADDRESS
                          (PID)
                        (SELECT AUDATA_ID FROM
                          (WITH CH AS 
                          (SELECT /*+ ORDERED USE_HASH(C) USE_HASH(P) NO_SWAP_JOIN_INPUTS(P)*/
							 P.AUDATA_ID,P.FIELD_TASK_ID
							  FROM TEMP_FILTER_IX_POINTADDRESS T,
							       AU_IX_POINTADDRESS_CHILDREN   C,
							       AU_IX_POINTADDRESS_PARENT     P
							 WHERE P.GROUP_ID = C.GROUP_ID
							   AND C.AUDATA_ID = T.PID)
                           SELECT CH.AUDATA_ID FROM CH,TEMP_AU_PA_FIELD_TASK TP WHERE CH.FIELD_TASK_ID=TP.PID
                           UNION ALL SELECT CH.AUDATA_ID FROM CH WHERE NOT EXISTS(SELECT 1 FROM TEMP_AU_PA_FIELD_TASK)));
                        ]]></sql>

        </step>

        <step value="13">

            <sql>
                <![CDATA[
                        INSERT /*+ append */
                        INTO TEMP_FILTER_IX_POINTADDRESS
                          (PID)
                          (SELECT P.PID FROM TEMP_IX_POINTADDRESS P);
                        ]]></sql>


        </step>
        <!--去重-->
        <step value="16">

            <sql>
                <![CDATA[TRUNCATE TABLE TEMP_IX_POINTADDRESS;]]></sql>


        </step>
        <!--去重-->
        <step value="19">

            <sql>
                <![CDATA[
                        INSERT /*+ append */
                        INTO TEMP_IX_POINTADDRESS
                          (PID)
                          (SELECT DISTINCT PID FROM TEMP_FILTER_IX_POINTADDRESS P);
                        ]]></sql>


        </step>

        <!--
            提取原则：
            1.按图幅提取
        -->
        <step value="100">
            <!--IX_POINTADDRESS-->
            <sql><![CDATA[SELECT P.* FROM AU_IX_POINTADDRESS P,TEMP_IX_POINTADDRESS T WHERE P.AUDATA_ID=T.PID;]]></sql>
             <!--IX_POINTADDRESS_NAME-->
            <sql><![CDATA[SELECT P.* FROM AU_IX_POINTADDRESS_NAME P,TEMP_IX_POINTADDRESS T WHERE P.AUDATA_ID=T.PID;]]></sql>
            <sql><![CDATA[
                          SELECT P.*
                              FROM AU_IX_POINTADDRESS_PARENT P, TEMP_IX_POINTADDRESS T
                             WHERE P.AUDATA_ID = T.PID;]]></sql>
            <sql><![CDATA[
                        SELECT P.*
                              FROM AU_IX_POINTADDRESS_CHILDREN P, TEMP_IX_POINTADDRESS T
                             WHERE P.AUDATA_ID = T.PID;]]></sql>
             <!--AU_IX_POINTADDRESS_FLAG-->
             <!-- glm190增加 -->
            <sql><![CDATA[SELECT P.* FROM AU_IX_POINTADDRESS_FLAG P,TEMP_IX_POINTADDRESS T WHERE P.AUDATA_ID=T.PID;]]></sql>
            
        </step>
    </feature>

</sqls>