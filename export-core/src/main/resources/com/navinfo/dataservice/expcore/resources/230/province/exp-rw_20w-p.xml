<?xml version="1.0" encoding="UTF-8"?>
<!--
@authur:liuqing
@time:2010-01-24
//TODO:没有建索引
-->
<sqls>
    <!--///////////////////////////////////////////////////铁路/////////////////////////////////////////////////////////-->
    <feature name="RW_LINK_FILTER">
        <step value="7">
            <!--按图幅过滤RW_LINK_20W-->
            <sql condition="mesh">
                <![CDATA[
                        INSERT /*+ append */
                        INTO TEMP_FILTER_RW_LINK
                          (PID)
                          (SELECT LINK_PID FROM RW_LINK_20W );
                        ]]></sql>

            <sql condition="area">
                <![CDATA[
                        INSERT /*+ append */
                        INTO TEMP_FILTER_RW_LINK
                          (PID)
                          (SELECT LINK_PID FROM RW_LINK_20W );
                        ]]></sql>
        </step>
    </feature>

    <feature name="RW_NODE_FILTER">
        <step value="7">
            <!--按图幅过滤RW_NODE-->
            <sql condition="mesh">
                <![CDATA[
                        INSERT /*+ append */
                        INTO TEMP_FILTER_RW_NODE
                          (PID)
                          (SELECT NODE_PID FROM RW_NODE_MESH_20W WHERE MESH_ID [mesh]);
                        ]]></sql>
            <sql condition="area">
                <![CDATA[
                        INSERT /*+ append */
                        INTO TEMP_FILTER_RW_NODE
                          (PID)
                          (SELECT NODE_PID FROM RW_NODE_20W WHERE SDO_ANYINTERACT(GEOMETRY,[area]) = 'TRUE');
                        ]]></sql>
        </step>
    </feature>


    <feature name="夸图幅Link">
        <!--
        查找夸图幅的图廓点，然后提取图廓点两边的link
        目前仅支持按图幅提取
        -->
        <step value="13">
            <sql condition="mesh"><![CDATA[
                    INSERT /*+ append */
                    INTO TEMP_RW_LINK
                      (PID)
                      (SELECT L.LINK_PID
                          FROM RW_LINK_20W L
                         WHERE L.S_NODE_PID IN (SELECT PID
                                                  FROM (SELECT COUNT(1), N.PID
                                                          FROM RW_NODE_MESH_20W M, TEMP_FILTER_RW_NODE N
                                                         WHERE N.PID = M.NODE_PID
                                                         GROUP BY N.PID
                                                        HAVING COUNT(1) > 1))
                        UNION
                        SELECT L.LINK_PID
                          FROM RW_LINK_20W L
                         WHERE L.E_NODE_PID IN (SELECT PID
                                                  FROM (SELECT COUNT(1), N.PID
                                                          FROM RW_NODE_MESH_20W M, TEMP_FILTER_RW_NODE N
                                                         WHERE N.PID = M.NODE_PID
                                                         GROUP BY N.PID
                                                        HAVING COUNT(1) > 1))
                        );
                    ]]></sql>


        </step>

    </feature>
    <!--
        /////////////////////////////////////////////////////////////////////////////////////////////
        ///////////////////////////////////铁路//////////////////////////////////////////////////////
        /////////////////////////////////////////////////////////////////////////////////////////////
    -->
    <feature name="RW_FEATURE">
        <!--
        铁路提取规则：
        1.根据link提取RW_FEATURE
        2.去重
        3.补充link
        4.提取铁路信息
        -->
        <step value="13">
            <!--根据link提取RW_FEATURE，并去重-->
            <sql>
                <![CDATA[
                        INSERT /*+ append */
                        INTO TEMP_RW_FEATURE
                          (PID)
                          (SELECT DISTINCT CN.FEATURE_PID
                             FROM TEMP_FILTER_RW_LINK N, RW_LINK_20W CN
                            WHERE N.PID = CN.LINK_PID
                            AND CN.FEATURE_PID!=0 AND CN.FEATURE_PID!=-1);
                        ]]></sql>

        </step>
        <step value="16">
            <!--根据link提取RW_FEATURE，并去重-->
            <sql>
                <![CDATA[
                        INSERT /*+ append */
                        INTO TEMP_RW_LINK
                          (PID)
                          (SELECT P.LINK_PID
                             FROM RW_LINK_20W P, TEMP_RW_FEATURE T
                            WHERE P.FEATURE_PID = T.PID);
                        ]]></sql>

        </step>
        <step value="19">
            <!--合并RW_LINK-->
            <sql><![CDATA[INSERT/*+ append */ INTO TEMP_FILTER_RW_LINK(PID)(SELECT PID FROM TEMP_RW_LINK);]]></sql>
        </step>
        <step value="22">
            <!--去重-->
            <sql>
                <![CDATA[
                        DELETE FROM TEMP_FILTER_RW_LINK A
                         WHERE A.ROWID !=
                               (SELECT MAX(B.ROWID) FROM TEMP_FILTER_RW_LINK B WHERE A.PID = B.PID);
                        ]]></sql>

        </step>

        <step value="25">


            <!--查询RW_LINK的两端端点并去重-->
            <sql><![CDATA[
                        INSERT /*+ append */
                        INTO TEMP_FILTER_RW_NODE
                          (PID)
                          (SELECT P.S_NODE_PID FROM RW_LINK_20W P, TEMP_FILTER_RW_LINK T WHERE P.LINK_PID = T.PID
                            UNION  ALL
                           SELECT P.E_NODE_PID FROM RW_LINK_20W P, TEMP_FILTER_RW_LINK T WHERE P.LINK_PID = T.PID
                           );
                        ]]></sql>

        </step>
         <step value="28">
            <!--去重-->
            <sql>
                <![CDATA[
                        DELETE FROM TEMP_FILTER_RW_NODE A
                         WHERE A.ROWID !=
                               (SELECT MAX(B.ROWID) FROM TEMP_FILTER_RW_NODE B WHERE A.PID = B.PID);
                        ]]></sql>
        </step>

        <step value="100">
            <!--
                提取铁路信息:
                1. RW_FEATURE_20W
                2. RW_LINK20W
                3. RW_NODE_20W
                4. RW_NODE_MESH_20W
            -->
            <sql><![CDATA[SELECT P.* FROM RW_FEATURE_20W P,TEMP_RW_FEATURE T WHERE P.FEATURE_PID=T.PID;]]></sql>
            <sql><![CDATA[SELECT P.* FROM RW_LINK_20W P,TEMP_FILTER_RW_LINK T WHERE P.LINK_PID=T.PID;]]></sql>
            <sql><![CDATA[SELECT P.* FROM RW_LINK_NAME_20W P,TEMP_FILTER_RW_LINK T WHERE P.LINK_PID=T.PID;]]></sql>
            <sql><![CDATA[
                        SELECT P.*
                          FROM RD_NAME P
                         WHERE P.NAME_GROUPID IN (SELECT P.NAME_GROUPID
                                                    FROM RW_LINK_NAME_20W P, TEMP_FILTER_RW_LINK T
                                                   WHERE P.LINK_PID = T.PID);
                         ]]></sql>
            <sql><![CDATA[SELECT P.* FROM RW_NODE_20W P,TEMP_FILTER_RW_NODE T WHERE P.NODE_PID=T.PID;]]></sql>
            <sql><![CDATA[SELECT P.* FROM RW_NODE_MESH_20W P,TEMP_FILTER_RW_NODE T WHERE P.NODE_PID=T.PID;]]></sql>
        </step>
    </feature>
</sqls>